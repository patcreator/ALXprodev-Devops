#!/bin/bash

# Task 5: Parallel Data Fetching (Advanced with timeout and kill)
# Objective: Speed up data retrieval using parallel processing,
# monitor background jobs, and terminate stuck processes

# Create directory for Pokémon data
mkdir -p pokemon_data

# List of Pokémon to fetch
pokemon_list=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")

# Timeout for each fetch (in seconds)
FETCH_TIMEOUT=15

# Function to fetch a single Pokémon
fetch_pokemon_parallel() {
    local pokemon=$1
    
    # Add small random delay to avoid overwhelming the API
    sleep $((RANDOM % 3))
    
    echo "Starting fetch for $pokemon (PID: $$)..."
    
    # Make API request
    curl -s --max-time $FETCH_TIMEOUT \
         "https://pokeapi.co/api/v2/pokemon/$pokemon" \
         -H "Accept: application/json" \
         -o "pokemon_data/${pokemon}.json"
    
    local exit_code=$?
    
    # Check if request was successful
    if [ $exit_code -eq 0 ] && [ -s "pokemon_data/${pokemon}.json" ]; then
        # Validate JSON response
        if jq empty "pokemon_data/${pokemon}.json" 2>/dev/null; then
            echo "Completed: $pokemon ✅"
        else
            echo "Failed: Invalid JSON for $pokemon"
            rm -f "pokemon_data/${pokemon}.json"
        fi
    else
        echo "Failed: Could not fetch $pokemon (curl exit: $exit_code)"
        rm -f "pokemon_data/${pokemon}.json"
    fi
}

# Start all fetches in parallel
echo "Starting parallel fetch for ${#pokemon_list[@]} Pokémon..."
echo "=========================================="

for pokemon in "${pokemon_list[@]}"; do
    fetch_pokemon_parallel "$pokemon" &
done

# Show running background jobs
echo ""
echo "Current background jobs:"
jobs
echo ""

# Monitor jobs with timeout and kill stuck processes
while true; do
    running_jobs=$(jobs -rp)  # get PIDs of running jobs
    if [ -z "$running_jobs" ]; then
        break
    fi

    for pid in $running_jobs; do
        # Check elapsed time for each job
        elapsed=$(ps -o etimes= -p "$pid" 2>/dev/null)
        if [ -n "$elapsed" ] && [ "$elapsed" -gt $FETCH_TIMEOUT ]; then
            echo "Process $pid exceeded timeout ($FETCH_TIMEOUT s). Killing..."
            kill -9 "$pid" 2>/dev/null
        fi
    done

    sleep 1
done

echo "=========================================="
echo "All background fetches completed!"
echo ""

# Summary of successful fetches
success_count=0
for pokemon in "${pokemon_list[@]}"; do
    if [ -f "pokemon_data/${pokemon}.json" ]; then
        success_count=$((success_count + 1))
    fi
done

echo "Successfully fetched $success_count out of ${#pokemon_list[@]} Pokémon."
